name: Failover to Secondary Region

on:
  workflow_dispatch:

env:
  PROJECT_ID: hot-cold-drp
  REGION: us-central1
  CLUSTER_NAME: gke-primary-cluster
  REPOSITORY: app-repo
  IMAGE: app-maintance

permissions:
  contents: read
  id-token: write

jobs:
  failover:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup gcloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          install_components: 'gke-gcloud-auth-plugin'

      - name: Configure Docker
        run: gcloud auth configure-docker us-central1-docker.pkg.dev

      - name: Build and Push Image
        run: |
          cd app/maintance
          docker build -t us-central1-docker.pkg.dev/$PROJECT_ID/$REPOSITORY/$IMAGE:$GITHUB_SHA .
          docker push us-central1-docker.pkg.dev/$PROJECT_ID/$REPOSITORY/$IMAGE:$GITHUB_SHA
          docker tag us-central1-docker.pkg.dev/$PROJECT_ID/$REPOSITORY/$IMAGE:$GITHUB_SHA \
                    us-central1-docker.pkg.dev/$PROJECT_ID/$REPOSITORY/$IMAGE:latest
          docker push us-central1-docker.pkg.dev/$PROJECT_ID/$REPOSITORY/$IMAGE:latest

      - name: Get GKE Credentials
        run: |
          gcloud container clusters get-credentials $CLUSTER_NAME \
            --region=$REGION --project=$PROJECT_ID
          export USE_GKE_GCLOUD_AUTH_PLUGIN=True

      - name: Deploy to GKE
        env:
          USE_GKE_GCLOUD_AUTH_PLUGIN: True
        run: |
          kubectl apply -f k8s/app-maintance.yaml
          kubectl scale deployment web-app --replicas=1

      - name: Promote database replica to primary
        run: |
          echo "ðŸ“Š Promoting database replica to primary"
          gcloud sql instances promote-replica replica-db-fb0e7775

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2

      - name: Terraform init
        run: terraform init

      - name: Deploy secondary infrastructure
        run: |
          echo "ðŸš€ Deploying secondary infrastructure due to primary failure"
          terraform apply -auto-approve -var="deploy_secondary=true"

      - name: Wait for secondary cluster to be ready
        run: |
          echo "â³ Waiting for secondary cluster to be ready..."
          sleep 60

      - name: Get secondary cluster credentials
        run: |
          gcloud container clusters get-credentials gke-secondary-cluster \
            --region=us-west1 --project=hot-cold-drp

      - name: Deploy app to secondary cluster
        env:
          USE_GKE_GCLOUD_AUTH_PLUGIN: True
        run: |
          kubectl apply -f k8s/app.yaml
          kubectl apply -f k8s/monitoring.yaml
          kubectl rollout status deployment/web-app --timeout=300s

      - name: Update load balancer to point to secondary
        run: |
          echo "ðŸ”„ Switching traffic to secondary region"
          # Get secondary NEG name
          NEG_NAME=$(gcloud compute network-endpoint-groups list --filter="name~k8s.*app-service" --format="value(name)" --zones=us-west1-a)
          echo "Secondary NEG: $NEG_NAME"
          
          # Update backend service to use secondary NEG
          # This would update your load balancer configuration
      
      - name: Wait for secondary cluster to be ready
        run: |
          echo "â³ Waiting for secondary cluster to be ready..."
          sleep 120

      - name: Get Service URLs
        env:
          USE_GKE_GCLOUD_AUTH_PLUGIN: True
        run: |
          echo "ðŸš€ Deployment Complete! Access your services:"
          echo "==========================================="
          
          # Get Load Balancer IP
          LB_IP=$(gcloud compute forwarding-rules list --region=us-west1 --format="value(IPAddress)" | head -1)
          if [ ! -z "$LB_IP" ]; then
            echo "ðŸ“± Application: http://$LB_IP"
          else
            echo "ðŸ“± Application: Load balancer IP not found"
          fi
          
          # Get Grafana IP
          GRAFANA_IP=$(kubectl get service grafana -n monitoring -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null || echo "pending")
          if [ "$GRAFANA_IP" != "pending" ] && [ ! -z "$GRAFANA_IP" ]; then
            echo "ðŸ“Š Grafana: http://$GRAFANA_IP:3000 (admin/admin123)"
          else
            echo "ðŸ“Š Grafana: IP pending, check 'kubectl get svc grafana -n monitoring'"
          fi
          
          # Get Prometheus IP
          PROMETHEUS_IP=$(kubectl get service prometheus -n monitoring -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null || echo "pending")
          if [ "$PROMETHEUS_IP" != "pending" ] && [ ! -z "$PROMETHEUS_IP" ]; then
            echo "ðŸ“ˆ Prometheus: http://$PROMETHEUS_IP:9090"
          else
            echo "ðŸ“ˆ Prometheus: IP pending, check 'kubectl get svc prometheus -n monitoring'"
          fi
          
          echo "==========================================="
          echo "Note: It may take 5-10 minutes for all services to be fully accessible"

      - name: Notify failover complete
        run: |
          echo "âœ… Failover to secondary region (us-west1) completed successfully"
          echo "Secondary cluster: gke-secondary-cluster"
          echo "Region: us-west1"
